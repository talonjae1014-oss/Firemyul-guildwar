<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üî• Î∂àÎ©∏ Í∏∏ÎìúÏ†Ñ (Golden Glory)</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Noto+Serif+KR:wght@400;700&family=Pretendard:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-deep: #050505;
    --bg-card: #121212;
    --gold-main: #d4af37;
    --gold-dim: #8a702a;
    --gold-bright: #fadd75;
    --text-main: #e0e0e0;
    --text-muted: #888;
    
    --win-color: #2e7d32;
    --lose-color: #8c1c1c;
    
    --font-serif: 'Noto Serif KR', serif;
    --font-dec: 'Cinzel', serif;
    --font-sans: 'Pretendard', sans-serif;
  }

  body {
    background-color: var(--bg-deep);
    background-image: radial-gradient(circle at 50% 0%, #222 0%, #050505 70%);
    color: var(--text-main);
    font-family: var(--font-sans);
    margin: 0; padding: 20px; padding-bottom: 100px;
    min-height: 100vh;
  }

  /* --- [ÌÉÄÏù¥Ìè¨Í∑∏ÎûòÌîº & Í≥µÌÜµ] --- */
  h2, h3, h4 { margin: 0; font-family: var(--font-serif); letter-spacing: -0.5px; }
  h2 { color: var(--gold-main); text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
  
  button {
    cursor: pointer; border: none; padding: 12px 20px; border-radius: 4px;
    font-family: var(--font-sans); font-weight: 600; transition: 0.3s;
    text-transform: uppercase; letter-spacing: 1px;
  }
  
  /* ÏûÖÎ†•Ï∞Ω: Î∞ëÏ§Ñ Ïä§ÌÉÄÏùº */
  input, select, textarea {
    background: transparent;
    border: none; border-bottom: 1px solid #444;
    color: #fff; padding: 12px 5px; width: 100%;
    box-sizing: border-box; margin-bottom: 15px;
    font-family: var(--font-sans); font-size: 1rem;
    transition: 0.3s; border-radius: 0;
  }
  input:focus, select:focus, textarea:focus {
    outline: none; border-bottom-color: var(--gold-main);
    box-shadow: 0 5px 10px -5px rgba(212, 175, 55, 0.2);
  }
  
  /* Ïä§ÌÅ¨Î°§Î∞î Ïª§Ïä§ÌÖÄ */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: #111; }
  ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

  /* --- [Î°úÍ∑∏Ïù∏ ÌôîÎ©¥] --- */
  #loginScreen {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 80vh; text-align: center;
  }
  .login-box {
    border: 1px solid var(--gold-dim);
    padding: 40px 30px; position: relative;
    background: rgba(10, 10, 10, 0.8);
    box-shadow: 0 0 30px rgba(0,0,0,0.8);
    width: 100%; max-width: 320px;
    backdrop-filter: blur(5px);
  }
  /* Î™®ÏÑúÎ¶¨ Ïû•Ïãù */
  .deco-corner {
    position: absolute; width: 15px; height: 15px;
    border: 2px solid var(--gold-main); pointer-events: none;
  }
  .tl { top: -1px; left: -1px; border-right: none; border-bottom: none; }
  .tr { top: -1px; right: -1px; border-left: none; border-bottom: none; }
  .bl { bottom: -1px; left: -1px; border-right: none; border-top: none; }
  .br { bottom: -1px; right: -1px; border-left: none; border-top: none; }

  .btn-gold {
    background: linear-gradient(135deg, var(--gold-dim) 0%, var(--gold-main) 100%);
    color: #000; width: 100%; margin-top: 20px;
    box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
  }
  .btn-gold:hover { filter: brightness(1.2); }

  /* --- [Î©îÏù∏ Î†àÏù¥ÏïÑÏõÉ] --- */
  #mainScreen { max-width: 600px; margin: 0 auto; display: none; }
  
  /* ÏÉÅÎã® ÌîÑÎ°úÌïÑ */
  .profile-header {
    border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 25px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .user-badge {
    border: 1px solid var(--gold-dim); padding: 5px 12px;
    font-size: 0.8rem; color: var(--gold-main); letter-spacing: 1px;
  }

  /* ÎìúÎ°≠Îã§Ïö¥ (Î∞©Ïñ¥ÌåÄ ÏÑ†ÌÉù) */
  .dropdown-wrapper { position: relative; margin-bottom: 30px; z-index: 100; }
  .glass-box {
    background: #1a1a1a; border: 1px solid #444;
    padding: 18px; display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; transition: 0.3s;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
  }
  .glass-box:hover { border-color: var(--gold-dim); }
  
  .dropdown-list {
    display: none; position: absolute; top: 100%; left: 0; width: 100%;
    background: #111; border: 1px solid var(--gold-dim);
    max-height: 400px; overflow-y: auto; z-index: 999;
    box-shadow: 0 10px 40px rgba(0,0,0,1);
  }
  .dropdown-item { 
    padding: 15px; border-bottom: 1px solid #222; cursor: pointer; 
    transition: 0.2s;
  }
  .dropdown-item:hover { background: #222; color: var(--gold-main); }
  .dropdown-item b { display: block; font-family: var(--font-serif); margin-bottom: 4px; }
  .dropdown-add-btn { text-align: center; color: var(--gold-main); border-top: 1px solid #333; }

  /* Í≥µÍ≤©ÌåÄ Í∑∏Î¶¨Îìú */
  #attackList {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 15px; margin-bottom: 30px;
  }
  .attack-btn {
    background: #151515; border: 1px solid #333;
    color: #bbb; padding: 20px 10px; border-radius: 2px;
    min-height: 90px; text-align: center;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    transition: 0.3s;
  }
  .attack-btn b { font-family: var(--font-serif); font-size: 1.05rem; margin-bottom: 5px; }
  .attack-btn:hover { border-color: #555; transform: translateY(-2px); }
  .attack-btn.active {
    background: linear-gradient(to bottom, #1a1a1a, #000);
    border: 1px solid var(--gold-main);
    color: var(--gold-main);
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.15);
  }

  /* ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ïπ¥Îìú (ÌïµÏã¨) */
  #attackCard {
    background: #101010; border: 1px solid var(--gold-dim);
    padding: 25px; margin-top: 20px; display: none;
    position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
  }
  #attackCard::before { /* ÏÉÅÎã® Í∏àÏÉâ ÎùºÏù∏ */
    content: ""; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, transparent, var(--gold-main), transparent);
  }
  
  .card-header {
    border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px;
  }
  .card-stat-big {
    font-family: var(--font-dec); font-size: 2.5rem; color: var(--gold-bright);
    float: right; line-height: 1; text-shadow: 0 0 10px rgba(212,175,55,0.4);
  }
  
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
  .info-item { background: #1a1a1a; padding: 12px; border: 1px solid #2a2a2a; }
  .info-label { display: block; color: var(--gold-dim); font-size: 0.75rem; margin-bottom: 5px; font-family: var(--font-serif); }
  .info-val { color: #eee; font-size: 0.95rem; }

  /* ÏäπÌå® Î≤ÑÌäº */
  .action-btns { display: flex; gap: 10px; margin-top: 25px; }
  .btn-win { 
    flex: 1; background: var(--win-color); color: #fff; 
    border: 1px solid #4a9c5d; box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
  }
  .btn-lose { 
    flex: 1; background: var(--lose-color); color: #fff; 
    border: 1px solid #d32f2f; box-shadow: 0 5px 15px rgba(198, 40, 40, 0.3);
  }

  /* Îû≠ÌÇπ Î¶¨Ïä§Ìä∏ */
  .rank-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px 10px; border-bottom: 1px solid #222;
  }
  .rank-badge-gold { color: #FFD700; text-shadow: 0 0 10px #FFD700; }
  .rank-badge-silver { color: #C0C0C0; text-shadow: 0 0 10px #C0C0C0; }
  .rank-badge-bronze { color: #CD7F32; text-shadow: 0 0 10px #CD7F32; }

  /* Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê */
  #adminPanel {
    background: #0f0f0f; border: 1px solid #444; border-top: 3px solid #666;
    padding: 20px; margin-top: 50px; display: none;
  }
  .mini-btn { padding: 4px 8px; font-size: 0.75rem; border-radius: 2px; text-transform: none; }
  
  /* Ï†úÎ≥¥ Î™®Îã¨ */
  #suggestModal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 2000;
    align-items: center; justify-content: center; backdrop-filter: blur(5px);
  }
  .modal-content {
    background: #111; padding: 30px; border: 1px solid var(--gold-dim);
    width: 90%; max-width: 400px;
    box-shadow: 0 0 40px rgba(0,0,0,1);
  }

  footer {
    text-align: center; margin-top: 80px; padding: 30px;
    color: #444; font-size: 0.8rem; border-top: 1px solid #111;
    font-family: var(--font-dec);
  }
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-box">
    <div class="deco-corner tl"></div><div class="deco-corner tr"></div>
    <div class="deco-corner bl"></div><div class="deco-corner br"></div>

    <h2 style="font-size:2.5rem; margin-bottom:10px;">IMMORTAL</h2>
    <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:40px; font-family:var(--font-serif);">Î∂àÎ©∏ Í∏∏ÎìúÏ†Ñ ÏûëÏ†Ñ ÏÉÅÌô©Ïã§</p>
    
    <input type="text" id="nickInput" placeholder="NICKNAME" style="text-align:center;">
    <input type="password" id="codeInput" placeholder="ACCESS CODE" style="text-align:center; letter-spacing: 5px;">
    
    <button onclick="tryLogin()" class="btn-gold">ENTER</button>
  </div>
  <div style="margin-top:30px;">
    <button onclick="adminLogin()" style="background:transparent; color:#333; font-size:0.7rem;">ADMIN ACCESS</button>
  </div>
</div>

<div id="mainScreen">
  
  <div class="profile-header">
    <div>
      <div id="currentNick" style="color:#fff; font-weight:bold; font-size:1.1rem; font-family:var(--font-serif);"></div>
      <div id="myStats" style="color:var(--text-muted); font-size:0.85rem; margin-top:5px;">Î°úÎî©Ï§ë...</div>
    </div>
    <button onclick="toggleAdmin()" id="adminBtn" class="user-badge" style="background:transparent; cursor:pointer;">
      ADMIN TOOL
    </button>
  </div>

  <div class="dropdown-wrapper">
    <div style="color:var(--gold-dim); font-size:0.8rem; margin-bottom:8px; margin-left:2px; font-family:var(--font-dec);">Target Defense Team</div>
    <div class="glass-box" onclick="toggleDropdown()">
      <span id="defCurrentText" style="font-weight:bold; color:#fff;">Î∞©Ïñ¥ÌåÄÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</span>
      <span style="color:var(--gold-main);">‚ñº</span>
    </div>
    
    <div id="defListDropdown" class="dropdown-list">
      <div style="padding:15px; border-bottom:1px solid #222; background:#0f0f0f; position:sticky; top:0; z-index:10;">
        <input type="text" id="defSearchInput" placeholder="Search..." style="margin:0; text-align:left;" oninput="filterDefense()" onclick="event.stopPropagation()">
      </div>
      <div id="defRealList"></div>
      <div id="defAddBtnArea"></div>
    </div>
  </div>

  <div id="attackList"></div>
  
  <div id="suggestBtnArea" style="text-align:center; margin-bottom:20px; display:none;">
    <button onclick="openSuggestModal()" style="background:transparent; border:1px dashed #444; color:#666; width:100%; padding:15px;">
      + New Strategy Suggestion
    </button>
  </div>

  <div id="attackCard">
    <div class="card-header">
      <div class="card-stat-big"><span id="cardRate">0</span><span style="font-size:1rem; color:#666;">%</span></div>
      <h2 style="font-size:1.5rem; color:#fff; margin-bottom:5px;">
        <span id="cardFire"></span> <span id="cardName"></span>
      </h2>
      <div id="cardMaker" style="font-size:0.8rem; color:var(--gold-dim); font-family:var(--font-dec);"></div>
    </div>

    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">RECORD</span>
        <span class="info-val"><span id="cardWin">0</span>Ïäπ <span id="cardLose">0</span>Ìå®</span>
      </div>
      <div class="info-item">
        <span class="info-label">TYPE</span>
        <span class="info-val" id="cardType">-</span>
      </div>
      
      <div class="info-item">
        <span class="info-label">RING</span>
        <span class="info-val" id="cardRing">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">PET</span>
        <span class="info-val" id="cardPet">-</span>
      </div>

      <div class="info-item" style="grid-column: span 2;">
        <span class="info-label">FORMATION</span>
        <span class="info-val" id="cardFormation">-</span>
      </div>
      
      <div class="info-item" style="grid-column: span 2;">
        <span class="info-label">SKILL ORDER</span>
        <span class="info-val" id="cardSkill">-</span>
      </div>
      
      <div class="info-item" style="grid-column: span 2;">
        <span class="info-label">NOTE & EQUIP</span>
        <div class="info-val" id="cardArmor" style="line-height:1.4;">-</div>
      </div>
      <div class="info-item" style="grid-column: span 2; border-color:transparent; padding:0;">
        <span class="info-label">RECENT HISTORY (Last 5)</span>
        <div id="recentRecord" style="font-family:var(--font-dec); font-size:1.2rem; margin-top:5px; letter-spacing:5px;">-</div>
      </div>
    </div>

    <div class="action-btns">
      <button class="btn-win" onclick="addWin()">VICTORY</button>
      <button class="btn-lose" onclick="addLose()">DEFEAT</button>
    </div>
    <div style="text-align:right; margin-top:15px;">
       <button onclick="resetRecord()" style="background:transparent; color:#444; font-size:0.75rem; padding:0;">[ Reset Record ]</button>
    </div>
  </div>

  <div style="margin-top:60px; border-top:1px solid #222; padding-top:30px;">
    <h3 style="color:var(--gold-dim); font-size:1.1rem; text-align:center; margin-bottom:20px; font-family:var(--font-dec);">
      HALL OF FAME
    </h3>
    <div id="rankingList"></div>
    <div id="moreRankMsg" style="text-align:center; color:#444; font-size:0.8rem; margin-top:15px; display:none;">
      * Top 10 Only (Admin View All)
    </div>
  </div>

  <div id="adminPanel">
    <h3 style="color:#fff; margin-bottom:20px;">ADMINISTRATOR</h3>
    
    <div style="background:#151515; padding:15px; margin-bottom:20px; border:1px solid #333;">
      <h4 style="color:#8f8; font-size:0.9rem;">ACCESS KEYS</h4>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <input type="text" id="newUserNick" placeholder="User Nickname" style="margin:0;">
        <button onclick="issueKey()" style="background:#28a745; color:#fff; width:80px;">ADD</button>
      </div>
      <div id="userKeyList" style="max-height:150px; overflow-y:auto; margin-top:15px; border-top:1px solid #222; padding-top:10px;"></div>
    </div>

    <div style="background:#1a1515; padding:15px; margin-bottom:20px; border:1px solid #522;">
      <h4 style="color:#f88; font-size:0.9rem;">SUGGESTIONS</h4>
      <div id="suggestionList" style="color:#666; font-size:0.8rem; margin-top:10px;">(None)</div>
    </div>

    <div style="margin-bottom:30px;">
      <h4 style="font-size:0.9rem; color:#aaa; margin-bottom:10px;">DEFENSE TEAM MGT</h4>
      <input type="text" id="defName" placeholder="New Defense Team Name">
      <div style="display:flex; gap:5px;">
        <button onclick="addDefense()" style="background:#333; color:#fff; flex:1;">ADD</button>
        <button onclick="delDefense()" style="background:#500; color:#fff; flex:1;">DELETE CURRENT</button>
      </div>
    </div>
    
    <div>
      <h4 style="font-size:0.9rem; color:#aaa; margin-bottom:10px;">ATTACK TEAM MGT (Manual)</h4>
      <input type="text" id="atkName" placeholder="Name">
      <select id="atkType">
        <option value="" disabled selected>Type</option>
        <option value="ÏÜçÍ≥µ Îî∞Ïïº Ìï®">‚ö° ÏÜçÍ≥µ Îî∞Ïïº Ìï®</option>
        <option value="ÎÇ¥Ï§òÎèÑ Îê®">üõ°Ô∏è ÎÇ¥Ï§òÎèÑ Îê®</option>
      </select>
      
      <div style="display:flex; gap:10px;">
        <input type="text" id="ringRec" placeholder="Ring">
        <input type="text" id="atkPet" placeholder="Pet">
      </div>
      <input type="text" id="atkFormation" placeholder="Formation">
      <textarea id="armorRec" rows="2" placeholder="Notes"></textarea>
      <input type="text" id="skillOrder" placeholder="Skill Order">
      
      <div style="margin-top:10px; display:flex; gap:5px;">
        <button onclick="addAttack()" style="background:#333; color:#fff; flex:1;">ADD</button>
        <button onclick="editAttack()" style="background:#0d6efd; color:#fff; flex:1;">SAVE</button>
        <button onclick="delAttack()" style="background:#500; color:#fff; flex:1;">DEL</button>
      </div>
    </div>
    
    <hr style="border-color:#333; margin:30px 0;">
    <h4 style="font-size:0.9rem; color:#aaa;">USER SCORES</h4>
    <div id="adminUserList" style="max-height:300px; overflow-y:auto; background:#000; padding:10px; margin-top:10px;"></div>
  </div>

  <footer>
    IMMORTAL GUILD WAR SYSTEM<br>
    <span style="color:#333; font-family:var(--font-sans);">Ver 2.0 Golden Glory Edition</span>
  </footer>
</div>

<div id="suggestModal">
  <div class="modal-content">
    <h3 style="color:var(--gold-main); margin-bottom:20px;">STRATEGY REPORT</h3>
    <input type="text" id="sugName" placeholder="Deck Name (Required)">
    <select id="sugType">
      <option value="" disabled selected>Type (Required)</option>
      <option value="ÏÜçÍ≥µ Îî∞Ïïº Ìï®">‚ö° ÏÜçÍ≥µ Îî∞Ïïº Ìï®</option>
      <option value="ÎÇ¥Ï§òÎèÑ Îê®">üõ°Ô∏è ÎÇ¥Ï§òÎèÑ Îê®</option>
    </select>
    
    <div style="display:flex; gap:10px;">
      <input type="text" id="sugRing" placeholder="Ring">
      <input type="text" id="sugPet" placeholder="Pet">
    </div>
    <input type="text" id="sugFormation" placeholder="Formation">
    <textarea id="sugArmor" rows="2" placeholder="Notes / Equip"></textarea>
    <input type="text" id="sugSkill" placeholder="Skill Order">
    
    <div style="display:flex; gap:10px; margin-top:20px;">
      <button onclick="submitSuggestion()" class="btn-gold" style="flex:1;">SUBMIT</button>
      <button onclick="closeSuggestModal()" style="flex:1; background:#333; color:#fff;">CANCEL</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, set, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// [Firebase Config - Ïú†ÏßÄ]
const firebaseConfig = {
  apiKey: "AIzaSyCR5CJ6mrEWa7MM_vZFA4stfLbmTuDTun4",
  authDomain: "firemyul-1c54d.firebaseapp.com",
  databaseURL: "https://firemyul-1c54d-default-rtdb.firebaseio.com",
  projectId: "firemyul-1c54d",
  storageBucket: "firemyul-1c54d.firebasestorage.app",
  messagingSenderId: "1030916876773",
  appId: "1:1030916876773:web:aa19a4f3496e8981fd270c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PW = "1513";

let myNick = "";
let currentDefense = "";
let currentAttack = "";
let adminOpen = false;
let allLogsCache = []; 
let defenseDataCache = {}; 

window.onload = () => {
  const storedNick = localStorage.getItem("nickname");
  const storedKey = localStorage.getItem("accessKey");
  if (storedNick && storedKey) {
    checkLogin(storedNick, storedKey, true);
  } else {
    showLogin();
  }
};

function showLogin() {
  document.getElementById("loginScreen").style.display = "flex";
  document.getElementById("mainScreen").style.display = "none";
}

function showMain(nick) {
  myNick = nick;
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("mainScreen").style.display = "block";
  document.getElementById("currentNick").textContent = `COMMANDER : ${myNick}`;
}

window.tryLogin = () => {
  const nick = document.getElementById("nickInput").value.trim();
  const key = document.getElementById("codeInput").value.trim();
  if(!nick || !key) return alert("Please enter Nickname and Code.");
  checkLogin(nick, key, false);
};

async function checkLogin(nick, key, isAuto) {
  const userRef = ref(db, `allowedUsers/${nick}`);
  const snap = await get(userRef);
  if (snap.exists() && snap.val().code === key) {
    localStorage.setItem("nickname", nick);
    localStorage.setItem("accessKey", key); 
    showMain(nick);
  } else {
    if(!isAuto) alert("‚ùå Invalid Nickname or Code.");
    else showLogin();
  }
}

window.adminLogin = () => {
  const pw = prompt("ADMIN PASSWORD");
  if(pw === ADMIN_PW) {
    alert("Admin Access Granted.");
    localStorage.setItem("nickname", "Í¥ÄÎ¶¨Ïûê");
    localStorage.setItem("accessKey", "ADMIN");
    showMain("Í¥ÄÎ¶¨Ïûê");
    toggleAdmin(); 
  } else {
    alert("Access Denied.");
  }
};

function checkPW(){
  const pw = prompt("Confirm Password");
  if(pw !== ADMIN_PW) { alert("Wrong Password"); return false; }
  return true;
}

window.toggleAdmin = () => {
  const panel = document.getElementById("adminPanel");
  if(!adminOpen){
    if(!checkPW()) return;
    panel.style.display="block";
    adminOpen=true;
    renderUserKeys(); 
  }else{
    panel.style.display="none";
    adminOpen=false;
  }
  renderRanking();
  renderAdminUserList(); 
  renderSuggestions(); 
};

window.issueKey = async () => {
  const nick = document.getElementById("newUserNick").value.trim();
  if(!nick) return alert("Enter Nickname");
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  await set(ref(db, `allowedUsers/${nick}`), { code: code, createdAt: Date.now() });
  document.getElementById("newUserNick").value = "";
  renderUserKeys();
};

window.deleteUserComplete = async (nick) => {
  if(!confirm(`WARNING: Delete all data for [${nick}]?`)) return;
  await remove(ref(db, `allowedUsers/${nick}`));
  const logsRef = ref(db, "logs");
  const snapshot = await get(logsRef);
  if (snapshot.exists()) {
    const updates = {};
    const data = snapshot.val();
    let count = 0;
    Object.keys(data).forEach(key => {
      if (data[key].nick === nick) { updates[key] = null; count++; }
    });
    if (count > 0) await update(logsRef, updates);
  }
  alert(`Deleted.`);
  renderUserKeys();
  renderRanking(); 
  renderAdminUserList(); 
};

function renderUserKeys() {
  const listDiv = document.getElementById("userKeyList");
  onValue(ref(db, "allowedUsers"), snap => {
    listDiv.innerHTML = "";
    const users = snap.val();
    if(!users) { listDiv.innerHTML = "<div style='color:#555;'>No Keys Issued.</div>"; return; }
    Object.entries(users).forEach(([nick, data]) => {
      const div = document.createElement("div");
      div.className = "key-row";
      div.style.marginBottom="5px";
      div.innerHTML = `
        <span style="color:#fff;">${nick} <span style="color:var(--gold-main); letter-spacing:2px; margin-left:10px;">${data.code}</span></span>
        <button onclick="deleteUserComplete('${nick}')" style="background:#700; color:#fff; font-size:0.7rem; padding:2px 6px;">DEL</button>
      `;
      listDiv.appendChild(div);
    });
  });
}

window.toggleDropdown = () => {
  const list = document.getElementById("defListDropdown");
  list.style.display = (list.style.display === "block") ? "none" : "block";
  if(list.style.display === "block"){
    document.getElementById("defSearchInput").value = "";
    filterDefense();
  }
};
window.addEventListener('click', (e) => {
  if (!e.target.closest('.dropdown-wrapper')) {
    document.getElementById("defListDropdown").style.display = "none";
  }
});

window.filterDefense = () => {
  const input = document.getElementById("defSearchInput");
  const filter = input.value.toLowerCase();
  const list = document.getElementById("defRealList");
  const items = list.getElementsByClassName("dropdown-item");
  for (let i = 0; i < items.length; i++) {
    const txt = items[i].textContent || items[i].innerText;
    if (txt.toLowerCase().indexOf(filter) > -1) items[i].style.display = "";
    else items[i].style.display = "none";
  }
};

onValue(ref(db,"defenseTeams"), snap => {
  const realList = document.getElementById("defRealList");
  const addBtnArea = document.getElementById("defAddBtnArea");
  realList.innerHTML = ""; addBtnArea.innerHTML = "";
  defenseDataCache = snap.val() || {}; 
  
  if(defenseDataCache) {
    Object.entries(defenseDataCache).forEach(([k, v]) => {
      const tWins = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.win||0),0);
      const tLose = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.lose||0),0);
      const rate = (tWins+tLose) ? Math.round(tWins/(tWins+tLose)*100) : 0;
      
      const div = document.createElement("div");
      div.className = "dropdown-item";
      div.innerHTML = `<b>${v.name}</b><small style="color:#666;">Success: ${rate}% (${tWins}W ${tLose}L)</small>`;
      div.onclick = () => {
        document.getElementById("defCurrentText").innerHTML = `${v.name} <span style="font-size:0.8em; color:var(--gold-dim);">(${rate}%)</span>`;
        document.getElementById("defListDropdown").style.display = "none";
        loadAttackTeams(k);
      };
      realList.appendChild(div);
    });
  } else {
    realList.innerHTML = "<div style='padding:15px; color:#555;'>No Data</div>";
  }

  const addBtn = document.createElement("div");
  addBtn.className = "dropdown-item dropdown-add-btn";
  addBtn.innerHTML = "<b>Ôºã Add Defense Team</b>";
  addBtn.onclick = () => {
    const newName = prompt("Name of Defense Team:");
    if(newName && newName.trim() !== "") {
      push(ref(db, "defenseTeams"), { name: newName.trim(), attackTeams: {} });
      document.getElementById("defListDropdown").style.display = "none";
    }
  };
  addBtnArea.appendChild(addBtn);
});

window.loadAttackTeams = (dk) => {
  currentDefense = dk; currentAttack = ""; 
  document.getElementById("attackCard").style.display = "none";
  document.getElementById("suggestBtnArea").style.display = "block";
  const attackList = document.getElementById("attackList");
  attackList.innerHTML="";

  onValue(ref(db,`defenseTeams/${dk}/attackTeams`), snap => {
    attackList.innerHTML="";
    const d = snap.val(); if(!d) return;
    Object.entries(d).forEach(([ak, av]) => {
      const t = av.win + av.lose;
      const r = t ? Math.round(av.win/t*100) : 0;
      const b = document.createElement("button");
      b.className = "attack-btn";
      const fire = r >= 70 ? "<span style='color:#ff4444'>üî•</span> " : "";
      b.innerHTML = `<b>${fire}${av.name}</b><small style="font-size:0.75rem; color:#777;">${r}%</small>`;
      b.onclick = () => {
        document.querySelectorAll(".attack-btn").forEach(btn => btn.classList.remove("active"));
        b.classList.add("active");
        selectAttack(dk, ak);
      };
      attackList.appendChild(b);
    });
  });
  renderSuggestions(); 
};

window.openSuggestModal = () => { document.getElementById("suggestModal").style.display = "flex"; };
window.closeSuggestModal = () => { document.getElementById("suggestModal").style.display = "none"; };

window.submitSuggestion = () => {
  if(!currentDefense) return alert("Select Defense Team First.");
  const name = document.getElementById("sugName").value;
  if(!name) return alert("Name Required.");
  const data = {
    name: name, type: document.getElementById("sugType").value,
    ring: document.getElementById("sugRing").value,
    pet: document.getElementById("sugPet").value, 
    formation: document.getElementById("sugFormation").value,
    armor: document.getElementById("sugArmor").value,
    skill: document.getElementById("sugSkill").value,
    suggester: myNick, timestamp: Date.now()
  };
  push(ref(db, `suggestions/${currentDefense}`), data).then(() => {
    alert("Report Submitted.");
    closeSuggestModal();
    // input reset
    document.getElementById("sugName").value = "";
    document.getElementById("sugType").value = "";
    document.getElementById("sugRing").value = "";
    document.getElementById("sugPet").value = "";
    document.getElementById("sugFormation").value = ""; 
    document.getElementById("sugArmor").value = "";
    document.getElementById("sugSkill").value = "";
  });
};

function renderSuggestions() {
  const listDiv = document.getElementById("suggestionList");
  onValue(ref(db, "suggestions"), snap => {
    listDiv.innerHTML = "";
    const allSugs = snap.val();
    if(!allSugs) { listDiv.innerHTML = "(None)"; return; }
    Object.entries(allSugs).forEach(([defKey, suggs]) => {
      const defName = defenseDataCache[defKey] ? defenseDataCache[defKey].name : "Unknown";
      Object.entries(suggs).forEach(([sugKey, data]) => {
        const div = document.createElement("div");
        div.style.marginBottom="10px"; div.style.borderBottom="1px solid #333"; div.style.paddingBottom="5px";
        div.innerHTML = `
          <div style="color:#aaa;">Target: ${defName}</div>
          <div style="color:#fff;">${data.name} <small>(by ${data.suggester})</small></div>
          <div style="margin-top:5px; display:flex; gap:5px;">
            <button class="mini-btn" style="background:#28a745; color:#fff;" onclick="approveSuggestion('${defKey}', '${sugKey}')">O</button>
            <button class="mini-btn" style="background:#dc3545; color:#fff;" onclick="rejectSuggestion('${defKey}', '${sugKey}')">X</button>
          </div>
        `;
        listDiv.appendChild(div);
      });
    });
  });
}

window.approveSuggestion = async (defKey, sugKey) => {
  if(!confirm("Approve?")) return;
  const snap = await get(ref(db, `suggestions/${defKey}/${sugKey}`));
  if(!snap.exists()) return;
  const data = snap.val();
  const newAttack = {
    name: data.name, type: data.type, 
    ring: data.ring, pet: data.pet || "", 
    formation: data.formation || "",
    armor: data.armor, skill: data.skill,
    win: 0, lose: 0, maker: data.suggester 
  };
  await push(ref(db, `defenseTeams/${defKey}/attackTeams`), newAttack);
  await remove(ref(db, `suggestions/${defKey}/${sugKey}`));
  alert("Approved.");
};
window.rejectSuggestion = async (defKey, sugKey) => {
  if(!confirm("Reject?")) return;
  await remove(ref(db, `suggestions/${defKey}/${sugKey}`));
  alert("Rejected.");
};

window.selectAttack = (dk, ak) => {
  currentAttack = ak;
  onValue(ref(db,`defenseTeams/${dk}/attackTeams/${ak}`), snap => {
    const d = snap.val(); if(!d) return;
    document.getElementById("attackCard").style.display = "block";
    document.getElementById("cardName").textContent = d.name;
    document.getElementById("cardMaker").textContent = d.maker ? `Strategist: ${d.maker}` : "";
    
    document.getElementById("cardWin").textContent = d.win;
    document.getElementById("cardLose").textContent = d.lose;
    const total = d.win + d.lose;
    const rateVal = total ? Math.round(d.win / total * 100) : 0;
    document.getElementById("cardRate").textContent = rateVal;
    document.getElementById("cardFire").textContent = rateVal >= 70 ? "üî•" : "";
    document.getElementById("cardType").textContent = d.type || "-";
    document.getElementById("cardRing").textContent = d.ring || "-";
    document.getElementById("cardPet").textContent = d.pet || "-";
    document.getElementById("cardFormation").textContent = d.formation || "-";
    document.getElementById("cardArmor").innerHTML = (d.armor || "-").replace(/\n/g,"<br>");
    document.getElementById("cardSkill").textContent = d.skill || "-";
    loadRecentRecord(dk, ak);
    
    document.getElementById("atkName").value=d.name; 
    document.getElementById("atkType").value=d.type; 
    document.getElementById("ringRec").value=d.ring; 
    document.getElementById("atkPet").value=d.pet || ""; 
    document.getElementById("atkFormation").value=d.formation || ""; 
    document.getElementById("armorRec").value=d.armor; 
    document.getElementById("skillOrder").value=d.skill;
  });
};

async function loadRecentRecord(defenseKey, attackKey){
  const snap = await get(ref(db,"logs"));
  const recordDiv = document.getElementById("recentRecord");
  if(!snap.exists()) { recordDiv.innerHTML = "-"; return; }
  const logs = Object.values(snap.val()).filter(v => v.defense === defenseKey && v.attack === attackKey).sort((a,b)=>b.time-a.time).slice(0,5);
  let html = "";
  logs.forEach(v => { html += (v.result === "win" ? "<span style='color:#4caf50;'>W</span> " : "<span style='color:#b71c1c;'>L</span> "); });
  recordDiv.innerHTML = html || "-";
}

async function writeLog(result){
  if(!currentDefense || !currentAttack) return alert("Error");
  const snap = await get(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`));
  if(!snap.exists()) { loadAttackTeams(currentDefense); return; }
  const atk = snap.val();
  set(push(ref(db,"logs")),{
    nick: myNick, result, defense: currentDefense, attack: currentAttack,
    attackName: atk.name || "", attackType: atk.type || "", date: new Date().toISOString().slice(0,10), time: Date.now()
  });
}

window.addWin = async () => {
  if(!currentDefense || !currentAttack) return alert("Select Team");
  if (!confirm(`Record Victory?`)) return;
  const w = +document.getElementById("cardWin").textContent;
  update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { win: w + 1 });
  writeLog("win");
};
window.addLose = async () => {
  if(!currentDefense || !currentAttack) return alert("Select Team");
  if (!confirm(`Record Defeat?`)) return;
  const l = +document.getElementById("cardLose").textContent;
  update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { lose: l + 1 });
  writeLog("lose");
};
window.resetRecord = () => {
  if(!checkPW()) return;
  if(!currentAttack) return alert("Select Attack Team");
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{win:0,lose:0});
};
window.addDefense = ()=>{ if(checkPW()) set(push(ref(db,"defenseTeams")),{name:document.getElementById("defName").value,attackTeams:{}}); };
window.delDefense = ()=>{ if(checkPW()) remove(ref(db,"defenseTeams/"+currentDefense)); };

window.addAttack = ()=>{
  if(!checkPW()) return;
  set(push(ref(db,`defenseTeams/${currentDefense}/attackTeams`)),{
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value, 
    ring:document.getElementById("ringRec").value, pet:document.getElementById("atkPet").value, 
    formation:document.getElementById("atkFormation").value,
    armor:document.getElementById("armorRec").value, skill:document.getElementById("skillOrder").value, win:0, lose:0
  });
};
window.editAttack = ()=>{
  if(!checkPW() || !currentAttack) return;
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value, 
    ring:document.getElementById("ringRec").value, pet:document.getElementById("atkPet").value,
    formation:document.getElementById("atkFormation").value,
    armor:document.getElementById("armorRec").value, skill:document.getElementById("skillOrder").value
  });
  alert("Saved.");
};
window.delAttack = ()=>{ if(checkPW() && currentAttack) remove(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`)); };

onValue(ref(db,"logs"), snap => { allLogsCache = snap.val() || {}; renderRanking(); if(adminOpen) renderAdminUserList(); });

function renderRanking() {
  const rankingList = document.getElementById("rankingList");
  const msg = document.getElementById("moreRankMsg");
  rankingList.innerHTML = "";
  if(!Object.keys(allLogsCache).length) {
    rankingList.innerHTML = "<div style='text-align:center; padding:10px; color:#555;'>No Records Yet</div>";
    document.getElementById("myStats").textContent = "No Records"; 
    return;
  }
  const userLogs = {};
  Object.values(allLogsCache).forEach(v => {
    if (!userLogs[v.nick]) userLogs[v.nick] = [];
    userLogs[v.nick].push(v);
  });
  const rankingData = Object.keys(userLogs).map(nick => {
    const logs = userLogs[nick];
    logs.sort((a, b) => b.time - a.time);
    const totalWin = logs.filter(l => l.result === "win").length;
    const totalLose = logs.filter(l => l.result === "lose").length;
    const recentLogs = logs.slice(0, 30);
    const recentWin = recentLogs.filter(l => l.result === "win").length;
    const recentLose = recentLogs.filter(l => l.result === "lose").length;
    return { nick, totalWin, totalLose, recentWin, recentLose };
  });
  rankingData.sort((a, b) => b.totalWin - a.totalWin);

  const myData = rankingData.find(d => d.nick === myNick);
  if(myData) {
    const total = myData.totalWin + myData.totalLose;
    const rate = total ? Math.round(myData.totalWin / total * 100) : 0;
    document.getElementById("myStats").innerHTML = `${myData.totalWin}W ${myData.totalLose}L (${rate}%)`;
    document.getElementById("myStats").style.color = "var(--gold-main)";
  }

  let hiddenCount = 0;
  rankingData.forEach((d, index) => {
    if(!adminOpen && index >= 10) { hiddenCount++; return; }
    let badge = `<span style='width:20px; display:inline-block; text-align:center; color:#555;'>${index+1}</span>`;
    let nickStyle = "color:#bbb;";
    
    if(index === 0) { badge = "<span class='rank-badge-gold'>‚ôõ</span>"; nickStyle = "color:#FFD700; font-weight:bold;"; }
    else if(index === 1) { badge = "<span class='rank-badge-silver'>‚ôõ</span>"; nickStyle = "color:#C0C0C0; font-weight:bold;"; }
    else if(index === 2) { badge = "<span class='rank-badge-bronze'>‚ôõ</span>"; nickStyle = "color:#CD7F32; font-weight:bold;"; }

    const total = d.totalWin + d.totalLose;
    const winRate = total ? Math.round(d.totalWin / total * 100) : 0;
    const rTotal = d.recentWin + d.recentLose;
    const rRate = rTotal ? Math.round(d.recentWin / rTotal * 100) : 0;
    const fire = (rTotal > 0 && rRate >= 70) ? "üî•" : "";

    const div = document.createElement("div"); 
    div.className = "rank-row";
    if(adminOpen && index >= 10) div.style.background = "rgba(50,0,0,0.2)"; 

    div.innerHTML = `
      <div style="display:flex; align-items:center; gap:10px;">
        ${badge} <span style="${nickStyle}">${d.nick}</span>
      </div>
      <div style="text-align:right;">
        <div style="color:#ddd; font-family:var(--font-dec); font-weight:bold;">
          ${d.totalWin}W <span style="color:#555; font-size:0.9em;">/ ${d.totalLose}L</span>
        </div>
        <div style="color:#666; font-size:0.75rem; letter-spacing:0px;">
          (Rec: ${rRate}%${fire})
        </div>
      </div>
    `;
    rankingList.appendChild(div);
  });
  msg.style.display = hiddenCount > 0 ? "block" : "none";
}

window.adjustScore = async (nick, type, delta) => {
  if(delta === 1) {
    set(push(ref(db,"logs")),{
      nick: nick, result: type, defense: "admin", attack: "manual_adjust",
      attackName: "Admin", attackType: "", date: new Date().toISOString().slice(0,10), time: Date.now()
    });
  } else {
    const snap = await get(ref(db, "logs"));
    if(!snap.exists()) return alert("No Logs");
    const logs = Object.entries(snap.val()).map(([k,v]) => ({...v, key:k}))
      .filter(v => v.nick === nick && v.result === type).sort((a,b) => b.time - a.time);
    if(logs.length === 0) return alert("No Logs");
    await remove(ref(db, `logs/${logs[0].key}`));
  }
};
function renderAdminUserList() {
  const listDiv = document.getElementById("adminUserList"); listDiv.innerHTML = "";
  const stat = {};
  Object.values(allLogsCache).forEach(v=>{
    if(!stat[v.nick]) stat[v.nick] = {w:0, l:0};
    if(v.result === "win") stat[v.nick].w++; else stat[v.nick].l++;
  });
  Object.keys(stat).sort().forEach(nick => {
    const val = stat[nick];
    const div = document.createElement("div");
    div.style.padding = "10px"; div.style.borderBottom = "1px solid #222";
    div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.alignItems = "center";
    div.innerHTML = `
      <span style="font-weight:bold; width:80px; color:#aaa;">${nick}</span>
      <div style="display:flex; align-items:center; gap:5px;">
        <span style="color:#4caf50; font-size:0.8rem;">W:${val.w}</span>
        <button class="mini-btn" style="background:#222; color:#fff;" onclick="adjustScore('${nick}','win',1)">+</button>
        <button class="mini-btn" style="background:#400; color:#fff;" onclick="adjustScore('${nick}','win',-1)">-</button>
        <span style="color:#dc3545; font-size:0.8rem; margin-left:5px;">L:${val.l}</span>
        <button class="mini-btn" style="background:#222; color:#fff;" onclick="adjustScore('${nick}','lose',1)">+</button>
        <button class="mini-btn" style="background:#400; color:#fff;" onclick="adjustScore('${nick}','lose',-1)">-</button>
      </div>
    `;
    listDiv.appendChild(div);
  });
}
</script>
</body>
</html>
